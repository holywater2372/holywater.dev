---
const imported = import.meta.glob(
  '../content/gallery/*.{jpg,jpeg,png,webp,avif,gif}',
  {
    eager: true,
    query: '?url',
    import: 'default',
  },
) as Record<string, string>

const entries = Object.entries(imported)
const images = entries.map(([, url]) => url)
---

<div class="relative h-48 overflow-hidden rounded-lg border md:h-96">
  {
    images.length > 0 && (
      <img
        id="gallery-image"
        src=""
        alt="" 
        class="block h-full w-full object-cover transition-opacity duration-500"
        style="opacity: 0; will-change: opacity; transform: translateZ(0);"
      />
    )
  }
</div>

<script is:inline define:vars={{ images }}>
  // Pick random starting image on client side
  const randomIndex = Math.floor(Math.random() * images.length)
  let currentImage = images.length > 0 ? images[randomIndex] : ''
  let intervalId = null

  function showRandomImage() {
    const img = document.getElementById('gallery-image')
    if (!img || images.length === 0) return

    // Pick random image different from current
    let newImage
    do {
      const randomIndex = Math.floor(Math.random() * images.length)
      newImage = images[randomIndex]
    } while (newImage === currentImage && images.length > 1)
    
    currentImage = newImage

    // Preload new image first
    const preload = new Image()
    preload.onload = () => {
      // Fade out
      img.style.opacity = '0'
      
      // Change image after fade completes
      setTimeout(() => {
        img.src = currentImage
        img.style.opacity = '0.85'
      }, 500)
    }
    preload.src = newImage
  }

  function init() {
    if (intervalId) clearInterval(intervalId)
    
    const img = document.getElementById('gallery-image')
    if (!img || images.length === 0) return

    // Set the random starting image
    img.src = currentImage

    // Fade in the first image
    setTimeout(() => {
      img.style.opacity = '0.85'
    }, 100)

    if (images.length <= 1) return

    // Start random rotation every 10 seconds
    intervalId = setInterval(showRandomImage, 10000)
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init)
  } else {
    init()
  }

  document.addEventListener('astro:page-load', init)
  document.addEventListener('astro:before-preparation', () => {
    if (intervalId) clearInterval(intervalId)
  })
</script>