---
const imported = import.meta.glob(
  '../content/gallery/*.{jpg,jpeg,png,webp,avif,gif}',
  {
    eager: true,
    query: '?url',
    import: 'default',
  },
) as Record<string, string>

const entries = Object.entries(imported)
const images = entries.map(([, url]) => url)

// Pick random starting image
const randomStart = images.length > 0 ? images[Math.floor(Math.random() * images.length)] : ''
---

<div class="relative h-48 overflow-hidden rounded-lg border md:h-96">
  {
    images.length > 0 && (
      <img
        id="gallery-image"
        src={randomStart}
        alt="" 
        class="block h-full w-full object-cover transition-opacity duration-500"
        style="opacity: 0;"
      />
    )
  }
</div>

<script define:vars={{ images }}>
  let currentIndex = 0
  let intervalId = null

  function showRandomImage() {
    const img = document.getElementById('gallery-image')
    if (!img || images.length === 0) return

    // Pick random index different from current
    let newIndex
    do {
      newIndex = Math.floor(Math.random() * images.length)
    } while (newIndex === currentIndex && images.length > 1)
    
    currentIndex = newIndex

    // Fade out
    img.style.opacity = '0'
    
    // Change image after fade
    setTimeout(() => {
      img.src = images[currentIndex]
      img.style.opacity = '0.85'
    }, 500)
  }

  function init() {
    if (intervalId) clearInterval(intervalId)
    
    const img = document.getElementById('gallery-image')
    if (!img) return

    // Fade in the first image
    setTimeout(() => {
      img.style.opacity = '0.85'
    }, 100)

    if (images.length <= 1) return

    // Start random rotation every 10 seconds
    intervalId = setInterval(showRandomImage, 10000)
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init)
  } else {
    init()
  }

  document.addEventListener('astro:page-load', init)
  document.addEventListener('astro:before-preparation', () => {
    if (intervalId) clearInterval(intervalId)
  })
</script>