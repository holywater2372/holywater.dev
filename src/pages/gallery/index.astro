---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
// 최신 Astro에서는 Astro.glob 대신 import.meta.glob 사용\
// In the latest Astro, use import.meta.glob instead of Astro.glob
const imported = import.meta.glob(
  '../../content/gallery/*.{jpg,jpeg,png,webp,avif,gif}',
  {
    eager: true,
    query: '?url',
    import: 'default',
  },
) as Record<string, string>;

// 파일명 기준 정렬 후 URL 리스트로 변환
// Convert to a list of URLs after sorting by file name
const images = Object.entries(imported)
  .sort((a, b) => a[0].localeCompare(b[0]))
  .map(([, url]) => url)
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title="Gallery" />
  <Breadcrumbs items={[{ label: 'Gallery', icon: 'lucide:images' }]} />
  <section aria-label="Masonry Gallery" class="gallery-wrapper">
    <div class="masonry">
      {
        images.map((src, index) => (
          <div class="masonry-item" data-index={index}>
            <img src={src} alt="" loading="lazy" decoding="async" />
            <div class="overlay">
              <div class="overlay-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h6v6" />
                  <path d="M10 14 21 3" />
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                </svg>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
      <button class="lightbox-close" aria-label="Close lightbox">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <button class="lightbox-nav lightbox-prev" aria-label="Previous image">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
      </button>
      
      <button class="lightbox-nav lightbox-next" aria-label="Next image">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"></polyline>
        </svg>
      </button>
      
      <div class="lightbox-image-container">
        <img id="lightbox-image" src="" alt="" />
      </div>
      
      <div class="lightbox-counter">
        <span id="current-index">1</span> / <span id="total-images">{images.length}</span>
      </div>
    </div>
  </div>
</Layout>

<style>
  .gallery-wrapper {
    padding: 1rem;
    margin: 0 auto;
    max-width: 1200px;
  }

  .masonry {
    column-gap: 1rem;
  }

  /* 기본 1열 */
  .masonry {
    column-count: 1;
  }

  /* >= 640px */
  @media (min-width: 640px) {
    .masonry {
      column-count: 2;
    }
  }

  /* >= 1024px */
  @media (min-width: 1024px) {
    .masonry {
      column-count: 3;
    }
  }

  /* >= 1280px */
  @media (min-width: 1280px) {
    .masonry {
      column-count: 4;
    }
  }

  .masonry-item {
    break-inside: avoid;
    margin-bottom: 1rem;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }

  .masonry-item:hover {
    transform: translateY(-4px);
  }

  .masonry-item img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 8px;
    background: #111;
    transition: transform 0.3s ease;
  }

  .masonry-item:hover img {
    transform: scale(1.05);
  }

  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 8px;
  }

  .masonry-item:hover .overlay {
    opacity: 1;
  }

  .overlay-icon {
    color: white;
    transform: scale(0.8);
    transition: transform 0.3s ease;
  }

  .masonry-item:hover .overlay-icon {
    transform: scale(1);
  }

  /* Lightbox Styles */
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
    z-index: 1000;
  }

  .lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    z-index: 1001;
  }

  .lightbox-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 10px;
    z-index: 1002;
    transition: opacity 0.3s ease;
  }

  .lightbox-close:hover {
    opacity: 0.7;
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    cursor: pointer;
    padding: 15px;
    border-radius: 50%;
    transition: background-color 0.3s ease, opacity 0.3s ease;
    z-index: 1002;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox-prev {
    left: -60px;
  }

  .lightbox-next {
    right: -60px;
  }

  .lightbox-image-container {
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: 90vw;
    max-height: 90vh;
  }

  .lightbox-image-container img {
    max-width: min(90vw, 1200px);
    max-height: min(90vh, 800px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .lightbox-counter {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 14px;
    opacity: 0.8;
  }

  /* Mobile and Tablet adjustments */
  @media (max-width: 1440px) {
    .lightbox-content {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .lightbox-image-container {
      max-width: calc(100vw - 40px);
      max-height: calc(100vh - 140px);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    
    .lightbox-image-container img {
      max-width: min(100%, 500px);
      max-height: min(100%, 400px);
      width: auto;
      height: auto;
      object-fit: contain;
    }
    
    .lightbox-nav {
      position: fixed;
      bottom: 20px;
      top: auto;
      transform: none;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      pointer-events: auto;
    }
    
    .lightbox-prev {
      left: 20px;
    }
    
    .lightbox-next {
      right: 20px;
    }
    
    .lightbox-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      padding: 12px;
      pointer-events: auto;
    }
    
    .lightbox-counter {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
  }
</style>

<script>
  // Get all images and setup lightbox
  const images = Array.from(document.querySelectorAll('.masonry-item img')).map(img => img.src);
  const lightbox = document.getElementById('lightbox') as HTMLElement;
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const currentIndexEl = document.getElementById('current-index') as HTMLElement;
  const totalImagesEl = document.getElementById('total-images') as HTMLElement;
  const closeBtn = document.querySelector('.lightbox-close') as HTMLElement;
  const prevBtn = document.querySelector('.lightbox-prev') as HTMLElement;
  const nextBtn = document.querySelector('.lightbox-next') as HTMLElement;
  const backdrop = document.querySelector('.lightbox-backdrop') as HTMLElement;
  
  let currentImageIndex = 0;
  
  // Update total images counter
  totalImagesEl.textContent = images.length.toString();
  
  // Open lightbox
  function openLightbox(index: number) {
    currentImageIndex = index;
    lightboxImage.src = images[currentImageIndex];
    currentIndexEl.textContent = (currentImageIndex + 1).toString();
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  // Close lightbox
  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Navigate to previous image
  function prevImage() {
    currentImageIndex = currentImageIndex === 0 ? images.length - 1 : currentImageIndex - 1;
    lightboxImage.src = images[currentImageIndex];
    currentIndexEl.textContent = (currentImageIndex + 1).toString();
  }
  
  // Navigate to next image
  function nextImage() {
    currentImageIndex = currentImageIndex === images.length - 1 ? 0 : currentImageIndex + 1;
    lightboxImage.src = images[currentImageIndex];
    currentIndexEl.textContent = (currentImageIndex + 1).toString();
  }
  
  // Event listeners
  document.querySelectorAll('.masonry-item').forEach((item, index) => {
    item.addEventListener('click', () => openLightbox(index));
  });
  
  closeBtn.addEventListener('click', closeLightbox);
  backdrop.addEventListener('click', closeLightbox);
  prevBtn.addEventListener('click', prevImage);
  nextBtn.addEventListener('click', nextImage);
  
  // Prevent image clicks from closing lightbox
  lightboxImage.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // Also handle touch events for mobile
  backdrop.addEventListener('touchend', closeLightbox);
  
  // Prevent lightbox image container from closing when clicked/touched
  document.querySelector('.lightbox-image-container')?.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  document.querySelector('.lightbox-image-container')?.addEventListener('touchend', (e) => {
    e.stopPropagation();
  });
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;
    
    switch (e.key) {
      case 'Escape':
        closeLightbox();
        break;
      case 'ArrowLeft':
        prevImage();
        break;
      case 'ArrowRight':
        nextImage();
        break;
    }
  });
</script>